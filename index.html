<!DOCTYPE html>
<meta charset="utf-8">
<style>
    /* Legend Font Style */
    body {
        font: 11px sans-serif;
        background-color: #ffffff;
    }

    /* Legend Position Style */
    .legend {
        position: absolute;
        left: 20px;
        top: 30px;
    }

    .g-hed {
        text-align: center;
        text-transform: uppercase;
        font-weight: bold;
        font-size: 22px;
        margin: 3px 0;
    }

    .g-source-bold {
        text-align: left;
        font-size: 10px;
        font-weight: bold;
    }

    .g-source-reg {
        text-align: left;
        font-size: 10px;
    }

    .g-source {
        margin: 10px 0;
    }

    .g-chart {
        text-align: center;
    }

    .g-intro {
        font-size: 16px;
        margin: 0px 0px 10px 0px;
    }

    div.tooltip {
        position: absolute;
        left: 75px;
        text-align: center;
        height: 12px;
        padding: 8px;
        font-size: 13px;
        font-family: 'Proxima-Nova', sans-serif;
        background: #FFFFFF;
        border: 1px solid #989898;
        pointer-events: none;
    }

    .block {
        width: 18%;
        height: 15px;
        display: inline-block;
    }

</style>
<body>
<h5 class="g-hed"></h5>
<p class="g-intro"></p>
<div class="g-chart"></div>
<div class="g-source"><span class="g-source-bold"></span><span class="g-source-reg"></span></div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>

<script>

    //Creates tooltip and makes it invisiblae
    var div = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    //Sets dimensions
    var margin = {top: 60, left: 60, bottom: 60, right: 140}
        , width = window.outerWidth
        , width = width - margin.left - margin.right
        , mapRatio = .5
        , height = width * mapRatio;

    //Tells the nap what projection to use
    var projection = d3.geo.albersUsa()
        .scale(width)
        .translate([width / 2, height / 2]);

    //Tells the map how to draw the paths from the projection
    var path = d3.geo.path()
        .projection(projection);

    //Appened svg to page
    var map = d3.select(".g-chart").append("svg")
        .style('height', height + 'px')
        .style('width', width + 'px');

    //Load the files
    queue()
        .defer(d3.json, "us.json")
        .defer(d3.json, "maptemplate.json")
        .await(ready);

    //Moves selection to front
    d3.selection.prototype.moveToFront = function () {
        return this.each(function () {
            this.parentNode.appendChild(this);
        });
    };

    //Moves selection to back
    d3.selection.prototype.moveToBack = function () {
        return this.each(function () {
            var firstChild = this.parentNode.firstChild;
            if (firstChild) {
                this.parentNode.insertBefore(this, firstChild);
            }
        });
    };

    function ready(error, us, maptemplate) {
        if (error) throw error;
        var lowColor = '#f9f9f9'
        var highColor = '#027600'
        var minVal = d3.min(maptemplate.map(el => el.num)
    )
        var maxVal = d3.max(maptemplate.map(el => el.num)
    )
        var ramp = d3.scale.linear().domain([minVal, maxVal]).range([lowColor, highColor])

        //Pair data with state id
        var dataByFIPS = {};
        maptemplate.forEach(function (d) {
            dataByFIPS[d.FIPS] = +d.num * 100;
        });

        //Pair state name with state id
        var stateByFIPS = {};
        maptemplate.forEach(function (d) {
            stateByFIPS[d.FIPS] = d.state;
        });

        //Appends chart headline
        d3.select(".g-hed").text("Percentage of people with Wikipedia article by place of birth");

        //Append states
        map.append("g")
            .attr("class", "states")
            .selectAll("path")
            .data(topojson.feature(us, us.objects.states).features)
            .enter().append("path")
            .attr("d", path)
            //Color states
            .style("fill", function (d) {
                console.debug(d);
                return ramp((maptemplate.find(el => el.FIPS == d.id) || {}).num
            )
            })
            // .attr("class", function(d) { return quantize(dataByFIPS[d.id]); })
            //Hovers
            .on("mouseover", function (d) {
                var sel = d3.select(this);
                sel.moveToFront();
                d3.select(this).transition().duration(300).style("opacity", 0.8);
                div.transition().duration(300)
                    .style("opacity", 1)
                div.text(stateByFIPS[d.id] + ": " + dataByFIPS[d.id] + "%")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 30) + "px");
            })
            .on("mouseout", function () {
                var sel = d3.select(this);
                sel.moveToBack();
                d3.select(this)
                    .transition().duration(300)
                    .style("opacity", 1);
                div.transition().duration(300)
                    .style("opacity", 0);
            });

        //Appends chart source
        d3.select(".g-source-bold")
            .text("SOURCE: ")
            .attr("class", "g-source-bold");

        d3.select(".g-source-reg")
            .text("WIKIDATA")
            .attr("class", "g-source-reg");

        //RESPONSIVENESS
        d3.select(window).on('resize', resize);

        // add a legend
        var w = 140, h = 300;

        var key = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h)
            .attr("class", "legend");

        var legend = key.append("defs")
            .append("svg:linearGradient")
            .attr("id", "gradient")
            .attr("x1", "100%")
            .attr("y1", "0%")
            .attr("x2", "100%")
            .attr("y2", "100%")
            .attr("spreadMethod", "pad");

        legend.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", highColor)
            .attr("stop-opacity", 1);

        legend.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", lowColor)
            .attr("stop-opacity", 1);

        key.append("rect")
            .attr("width", w - 100)
            .attr("height", h)
            .style("fill", "url(#gradient)")
            .attr("transform", "translate(0,10)");

        var y = d3.scale.linear()
            .range([h, 0])
            .domain([minVal, maxVal]);

        var yAxis = d3.svg.axis().scale(y).orient("right");

        key.append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(41,10)")
            .call(yAxis)

        function resize() {

            var w = d3.select(".g-chart").node().clientWidth;
            console.log("resized", w);

            // adjust things when the window size changes
            width = w - margin.left - margin.right;
            height = width * mapRatio;

            console.log(width)
            // update projection
            var newProjection = d3.geo.albersUsa()
                .scale(width)
                .translate([width / 2, height / 2]);

            //Update path
            path = d3.geo.path()
                .projection(newProjection);

            // resize the map container
            map
                .style('width', width + 'px')
                .style('height', height + 'px');

            // resize the map
            map.selectAll("path").attr('d', path);
        }
    }

</script>
